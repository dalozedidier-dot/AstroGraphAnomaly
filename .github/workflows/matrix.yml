name: matrix

on:
  push:
  pull_request:
  workflow_dispatch: {}

jobs:
  smoke_matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Smoke test (offline) + summary
        run: |
          python - <<'PY'
          import os, sys, json, subprocess, pathlib

          out = pathlib.Path(f"results/ci_matrix_{os.environ.get('PY_VER','')}".strip("_"))
          # fallback si PY_VER n'est pas set
          if str(out) == "results/ci_matrix":
            out = pathlib.Path("results/ci_matrix") / f"py{sys.version_info.major}{sys.version_info.minor}"

          out.mkdir(parents=True, exist_ok=True)

          if os.path.exists("workflow.py"):
              cmd = [sys.executable, "workflow.py", "csv",
                     "--in-csv", "data/sample_gaia_like.csv",
                     "--out", str(out),
                     "--top-k", "10"]
          elif os.path.exists("run_workflow.py"):
              cmd = [sys.executable, "run_workflow.py",
                     "--mode", "csv",
                     "--in-csv", "data/sample_gaia_like.csv",
                     "--out", str(out),
                     "--top-k", "10"]
          else:
              raise SystemExit("ERROR: no workflow entrypoint found (workflow.py or run_workflow.py)")

          print("Running:", " ".join(cmd))
          subprocess.check_call(cmd)

          # Build a small report
          manifest_path = out / "manifest.json"
          scored_path = out / "scored.csv"
          top_path = out / "top_anomalies.csv"

          report = {
              "python": sys.version.split()[0],
              "out_dir": str(out),
              "has_manifest": manifest_path.exists(),
              "has_scored": scored_path.exists(),
              "has_top": top_path.exists(),
          }

          # minimal sanity numbers
          try:
              import pandas as pd
              if scored_path.exists():
                  df = pd.read_csv(scored_path)
                  report["rows_scored"] = int(len(df))
                  if "anomaly_label" in df.columns:
                      report["n_anomalies_label_-1"] = int((df["anomaly_label"] == -1).sum())
              if top_path.exists():
                  df2 = pd.read_csv(top_path)
                  report["rows_top"] = int(len(df2))
          except Exception as e:
              report["pandas_read_error"] = repr(e)

          # Write to GitHub step summary
          summary = os.environ.get("GITHUB_STEP_SUMMARY")
          if summary:
              with open(summary, "a", encoding="utf-8") as f:
                  f.write(f"## Matrix smoke â€” Python {report['python']}\n")
                  f.write(f"- out_dir: `{report['out_dir']}`\n")
                  f.write(f"- manifest: {report['has_manifest']}\n")
                  f.write(f"- scored.csv: {report['has_scored']} (rows={report.get('rows_scored','?')})\n")
                  f.write(f"- top_anomalies.csv: {report['has_top']} (rows={report.get('rows_top','?')})\n")
                  if "n_anomalies_label_-1" in report:
                      f.write(f"- anomalies(label=-1): {report['n_anomalies_label_-1']}\n")
                  f.write("\n")
          PY
        env:
          PY_VER: ${{ matrix.python }}

      - name: Upload matrix artefacts
        uses: actions/upload-artifact@v4
        with:
          name: ci_matrix_py${{ matrix.python }}
          path: results/ci_matrix_${{ matrix.python }}
          if-no-files-found: warn
