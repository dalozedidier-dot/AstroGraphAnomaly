name: "Manual run + Viz A to H (3D)"

on:
  workflow_dispatch:
    inputs:
      run_name:
        description: "Nom du run (dossier results/<run_name>)"
        required: true
        default: "manual_run"
      python_version:
        description: "Version Python"
        required: true
        default: "3.12"
      mode:
        description: "Mode: csv ou gaia"
        required: true
        default: "csv"
      in_csv:
        description: "CSV d'entrée (mode csv)"
        required: true
        default: "data/sample_gaia_like.csv"
      ra:
        description: "RA en degrés (mode gaia)"
        required: false
        default: "266.4051"
      dec:
        description: "Dec en degrés (mode gaia)"
        required: false
        default: "-28.936175"
      radius_deg:
        description: "Rayon en degrés (gaia), ignoré en csv si non utilisé"
        required: true
        default: "0.5"
      limit:
        description: "Limite lignes (0 = pas de limite)"
        required: true
        default: "2000"
      explain_top:
        description: "Nombre d'anomalies expliquées (LIME) si dispo"
        required: true
        default: "10"
      generate_viz:
        description: "Générer la suite Viz A à H (inclut HTML 3D)"
        required: true
        default: "true"

permissions:
  contents: read

jobs:
  run_and_viz:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: "pip"

      - name: Install requirements
        run: |
          python -V
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Install viz requirements (optional)
        run: |
          if [ -f requirements_viz.txt ]; then
            python -m pip install -r requirements_viz.txt
          else
            echo "requirements_viz.txt absent, viz suite possible mais certaines sorties HTML peuvent manquer"
          fi

      - name: Run core pipeline (run_workflow.py)
        env:
          RUN_NAME: ${{ inputs.run_name }}
          MODE: ${{ inputs.mode }}
          IN_CSV: ${{ inputs.in_csv }}
          RA: ${{ inputs.ra }}
          DEC: ${{ inputs.dec }}
          RADIUS_DEG: ${{ inputs.radius_deg }}
          LIMIT: ${{ inputs.limit }}
          EXPLAIN_TOP: ${{ inputs.explain_top }}
        run: |
          set -euo pipefail
          OUT_DIR="results/${RUN_NAME}"
          mkdir -p "${OUT_DIR}"

          if [ "${MODE}" = "gaia" ]; then
            python run_workflow.py \
              --mode gaia \
              --ra "${RA}" \
              --dec "${DEC}" \
              --radius-deg "${RADIUS_DEG}" \
              --limit "${LIMIT}" \
              --out "${OUT_DIR}" \
              --plots \
              --explain-top "${EXPLAIN_TOP}"
          else
            python run_workflow.py \
              --mode csv \
              --in-csv "${IN_CSV}" \
              --radius-deg "${RADIUS_DEG}" \
              --limit "${LIMIT}" \
              --out "${OUT_DIR}" \
              --plots \
              --explain-top "${EXPLAIN_TOP}"
          fi

          echo "Contenu du run:"
          ls -la "${OUT_DIR}" || true

      - name: Generate Viz A to H (HTML 3D included)
        if: ${{ inputs.generate_viz == 'true' }}
        env:
          RUN_NAME: ${{ inputs.run_name }}
        run: |
          set -euo pipefail
          RUN_DIR="results/${RUN_NAME}"

          if [ ! -f tools/viz_a_to_h_suite.py ]; then
            echo "tools/viz_a_to_h_suite.py absent"
            exit 1
          fi

          SCORED="${RUN_DIR}/scored.csv"
          GRAPH="${RUN_DIR}/graph_full.graphml"
          EXPLAIN="${RUN_DIR}/explanations.jsonl"

          if [ ! -f "${SCORED}" ]; then
            echo "Fichier manquant: ${SCORED}"
            exit 1
          fi

          ARGS=( --run-dir "${RUN_DIR}" --scored "${SCORED}" )

          if [ -f "${GRAPH}" ]; then
            ARGS+=( --graph "${GRAPH}" )
          else
            echo "graph_full.graphml absent, certaines viz réseau vont dégrader"
          fi

          if [ -f "${EXPLAIN}" ]; then
            ARGS+=( --explain "${EXPLAIN}" )
          else
            echo "explanations.jsonl absent, heatmaps explicabilité en fallback"
          fi

          python tools/viz_a_to_h_suite.py "${ARGS[@]}"

          echo "Fichiers viz produits:"
          find "${RUN_DIR}" -maxdepth 4 -type f \( -name "*.png" -o -name "*.html" -o -name "*.gif" \) | sort || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: astrographanomaly_${{ inputs.run_name }}
          path: results/${{ inputs.run_name }}
          if-no-files-found: error
          retention-days: 14
