name: manual_viz_a_to_h

on:
  workflow_dispatch:
    inputs:
      run_name:
        description: "Nom du run (dossier results/<run_name>)"
        required: true
        default: "manual_run"
      python_version:
        description: "Version Python"
        required: true
        default: "3.12"

      mode:
        description: "csv ou gaia"
        required: true
        default: "csv"
      in_csv:
        description: "CSV d'entrée (mode csv)"
        required: true
        default: "data/sample_gaia_like.csv"
      ra:
        description: "RA en degrés (mode gaia)"
        required: false
        default: "266.4051"
      dec:
        description: "Dec en degrés (mode gaia)"
        required: false
        default: "-28.936175"

      radius_deg:
        description: "Rayon en degrés"
        required: true
        default: "0.5"
      limit:
        description: "Limite lignes"
        required: true
        default: "2000"

      knn_k:
        description: "k du graphe kNN"
        required: true
        default: "8"
      contamination:
        description: "Contamination IsolationForest"
        required: true
        default: "0.05"
      top_k:
        description: "Top K anomalies exportées"
        required: true
        default: "30"
      explain_top:
        description: "Nombre d'anomalies expliquées"
        required: true
        default: "5"
      seed:
        description: "Seed"
        required: true
        default: "42"

      plots:
        description: "Produire les plots PNG"
        required: true
        default: "true"
      generate_viz:
        description: "Générer Viz A à H (HTML 3D)"
        required: true
        default: "true"

permissions:
  contents: read

jobs:
  run_and_viz:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      RUN_NAME: ${{ inputs.run_name }}
      MODE: ${{ inputs.mode }}
      IN_CSV: ${{ inputs.in_csv }}
      RA: ${{ inputs.ra }}
      DEC: ${{ inputs.dec }}
      RADIUS_DEG: ${{ inputs.radius_deg }}
      LIMIT: ${{ inputs.limit }}
      KNN_K: ${{ inputs.knn_k }}
      CONTAMINATION: ${{ inputs.contamination }}
      TOP_K: ${{ inputs.top_k }}
      EXPLAIN_TOP: ${{ inputs.explain_top }}
      SEED: ${{ inputs.seed }}
      PLOTS: ${{ inputs.plots }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: pip

      - name: Install deps
        run: |
          set -euo pipefail
          python -V
          python -m pip install --upgrade pip

          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          fi

          if [ -f requirements_viz.txt ]; then
            python -m pip install -r requirements_viz.txt
          fi

          if [ -f pyproject.toml ]; then
            python -m pip install -e .
          fi

      - name: Run core (run_workflow.py)
        run: |
          set -euo pipefail

          test -f run_workflow.py || (echo "run_workflow.py introuvable à la racine" && exit 1)

          PLOT_ARG=""
          if [ "${PLOTS}" = "true" ]; then
            PLOT_ARG="--plots"
          fi

          if [ "${MODE}" = "gaia" ]; then
            python run_workflow.py \
              --mode gaia \
              --ra "${RA}" \
              --dec "${DEC}" \
              --radius-deg "${RADIUS_DEG}" \
              --limit "${LIMIT}" \
              --knn-k "${KNN_K}" \
              --engine isolation_forest \
              --contamination "${CONTAMINATION}" \
              --top-k "${TOP_K}" \
              --explain-top "${EXPLAIN_TOP}" \
              --seed "${SEED}" \
              ${PLOT_ARG}
          else
            python run_workflow.py \
              --mode csv \
              --in-csv "${IN_CSV}" \
              --radius-deg "${RADIUS_DEG}" \
              --limit "${LIMIT}" \
              --knn-k "${KNN_K}" \
              --engine isolation_forest \
              --contamination "${CONTAMINATION}" \
              --top-k "${TOP_K}" \
              --explain-top "${EXPLAIN_TOP}" \
              --seed "${SEED}" \
              ${PLOT_ARG}
          fi

      - name: Collect outputs into results/<run_name>
        run: |
          set -euo pipefail

          RUN_DIR="results/${RUN_NAME}"
          mkdir -p "${RUN_DIR}"

          for f in raw.csv scored.csv scored_enriched.csv top_anomalies.csv graph_full.graphml graph_topk.graphml manifest.json explanations.jsonl llm_prompts.jsonl; do
            if [ -f "${f}" ]; then
              mv "${f}" "${RUN_DIR}/"
            fi
          done

          if [ -d plots ]; then
            mkdir -p "${RUN_DIR}/plots"
            mv plots/* "${RUN_DIR}/plots/" || true
            rmdir plots || true
          fi

          echo "Run dir:"
          ls -la "${RUN_DIR}" || true

      - name: Viz A to H (HTML 3D)
        if: ${{ inputs.generate_viz == 'true' }}
        run: |
          set -euo pipefail

          test -f tools/viz_a_to_h_suite.py || (echo "tools/viz_a_to_h_suite.py absent" && exit 1)

          RUN_DIR="results/${RUN_NAME}"
          test -f "${RUN_DIR}/scored.csv" || (echo "scored.csv absent dans ${RUN_DIR}" && exit 1)

          ARGS=( --run-dir "${RUN_DIR}" --scored "${RUN_DIR}/scored.csv" )

          if [ -f "${RUN_DIR}/graph_full.graphml" ]; then
            ARGS+=( --graph "${RUN_DIR}/graph_full.graphml" )
          fi

          if [ -f "${RUN_DIR}/explanations.jsonl" ]; then
            ARGS+=( --explain "${RUN_DIR}/explanations.jsonl" )
          fi

          python tools/viz_a_to_h_suite.py "${ARGS[@]}"

          echo "Outputs (png/html/gif):"
          find "${RUN_DIR}" -maxdepth 6 -type f \( -name "*.png" -o -name "*.html" -o -name "*.gif" \) | sort || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: astrographanomaly_${{ inputs.run_name }}
          path: results/${{ inputs.run_name }}
          if-no-files-found: error
          retention-days: 14
