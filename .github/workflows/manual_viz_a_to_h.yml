name: "Manual run + Viz A to H (3D HTML)"

on:
  workflow_dispatch:
    inputs:
      run_name:
        description: "Nom du run (dossier results/<run_name>)"
        required: true
        default: "manual_run"
      python_version:
        description: "Version Python"
        required: true
        default: "3.12"

      mode:
        description: "csv ou gaia"
        required: true
        default: "csv"
      in_csv:
        description: "CSV d'entrée (mode csv)"
        required: true
        default: "data/sample_gaia_like.csv"
      ra:
        description: "RA en degrés (mode gaia)"
        required: false
        default: "266.4051"
      dec:
        description: "Dec en degrés (mode gaia)"
        required: false
        default: "-28.936175"
      radius_deg:
        description: "Rayon en degrés"
        required: true
        default: "0.5"
      limit:
        description: "Limite lignes (0 = pas de limite)"
        required: true
        default: "2000"

      knn_k:
        description: "k du graphe kNN"
        required: true
        default: "8"
      contamination:
        description: "Contamination IsolationForest"
        required: true
        default: "0.05"
      top_k:
        description: "Top K anomalies exportées"
        required: true
        default: "30"
      explain_top:
        description: "Nombre d'anomalies expliquées (LIME si dispo)"
        required: true
        default: "5"
      seed:
        description: "Seed"
        required: true
        default: "42"

      plots:
        description: "Produire les plots PNG"
        required: true
        default: "true"
      generate_viz:
        description: "Générer la suite Viz A to H (inclut HTML 3D)"
        required: true
        default: "true"

permissions:
  contents: read

jobs:
  run_and_viz:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: "pip"

      - name: Install deps
        run: |
          set -euo pipefail
          python -V
          python -m pip install --upgrade pip

          if [ -f pyproject.toml ]; then
            python -m pip install -e ".[dev]" || python -m pip install -e .
          fi

          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          fi

          if [ -f requirements_viz.txt ]; then
            python -m pip install -r requirements_viz.txt
          else
            echo "requirements_viz.txt absent, les sorties HTML 3D risquent de manquer"
          fi

      - name: Sanity check expected files
        run: |
          set -euo pipefail
          ls -la
          test -f run_workflow.py || (echo "run_workflow.py introuvable à la racine" && exit 1)

          if [ "${{ inputs.generate_viz }}" = "true" ]; then
            test -f tools/viz_a_to_h_suite.py || (echo "tools/viz_a_to_h_suite.py absent, impossible de générer la 3D" && exit 1)
          fi

      - name: Run core pipeline (run_workflow.py)
        env:
          RUN_NAME: ${{_
