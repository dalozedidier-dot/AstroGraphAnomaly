name: manual_viz_a_to_h

on:
  workflow_dispatch:
    inputs:
      run_name:
        description: "Nom du run (dossier results/<run_name>)"
        required: true
        default: "manual_run"
      python_version:
        description: "Version Python"
        required: true
        default: "3.12"

      mode:
        description: "csv ou gaia"
        required: true
        default: "csv"
      in_csv:
        description: "CSV d'entr√©e (mode csv)"
        required: true
        default: "data/sample_gaia_like.csv"
      ra:
        description: "RA en degres (mode gaia)"
        required: false
        default: "266.4051"
      dec:
        description: "Dec en degres (mode gaia)"
        required: false
        default: "-28.936175"
      radius_deg:
        description: "Rayon en degres"
        required: true
        default: "0.5"
      limit:
        description: "Limite lignes"
        required: true
        default: "2000"

      knn_k:
        description: "k du graphe kNN"
        required: true
        default: "8"
      contamination:
        description: "Contamination IsolationForest"
        required: true
        default: "0.05"
      top_k:
        description: "Top K anomalies"
        required: true
        default: "30"
      explain_top:
        description: "Nombre d'anomalies expliquees (0 pour desactiver)"
        required: true
        default: "10"
      seed:
        description: "Seed"
        required: true
        default: "42"

      plots:
        description: "Produire les PNG (true/false)"
        required: true
        default: "true"
      generate_viz:
        description: "Generer Viz A a H (HTML 3D) (true/false)"
        required: true
        default: "true"

permissions:
  contents: read

jobs:
  run_and_viz:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: pip

      - name: Install deps
        run: |
          set -euo pipefail
          python -V
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          if [ -f requirements_viz.txt ]; then
            python -m pip install -r requirements_viz.txt
          fi

      - name: Sanity check required files
        run: |
          set -euo pipefail
          test -f run_workflow.py || (echo "run_workflow.py introuvable a la racine" && exit 1)
          if [ "${{ inputs.generate_viz }}" = "true" ]; then
            test -f tools/viz_a_to_h_suite.py || (echo "tools/viz_a_to_h_suite.py absent" && exit 1)
          fi

      - name: Run core workflow
        env:
          RUN_NAME: ${{ inputs.run_name }}
          MODE: ${{ inputs.mode }}
          IN_CSV: ${{ inputs.in_csv }}
          RA: ${{ inputs.ra }}
          DEC: ${{ inputs.dec }}
          RADIUS_DEG: ${{ inputs.radius_deg }}
          LIMIT: ${{ inputs.limit }}
          KNN_K: ${{ inputs.knn_k }}
          CONTAMINATION: ${{ inputs.contamination }}
          TOP_K: ${{ inputs.top_k }}
          EXPLAIN_TOP: ${{ inputs.explain_top }}
          SEED: ${{ inputs.seed }}
          PLOTS: ${{ inputs.plots }}
        run: |
          set -euo pipefail

          OUT_DIR="results/${RUN_NAME}"
          mkdir -p "${OUT_DIR}"

          PLOT_ARG=""
          if [ "${PLOTS}" = "true" ]; then
            PLOT_ARG="--plots"
          fi

          if [ "${MODE}" = "gaia" ]; then
            python run_workflow.py \
              --mode gaia \
              --ra "${RA}" \
              --dec "${DEC}" \
              --radius-deg "${RADIUS_DEG}" \
              --limit "${LIMIT}" \
              --knn-k "${KNN_K}" \
              --engine isolation_forest \
              --contamination "${CONTAMINATION}" \
              --top-k "${TOP_K}" \
              --explain-top "${EXPLAIN_TOP}" \
              --seed "${SEED}" \
              --out "${OUT_DIR}" \
              ${PLOT_ARG}
          else
            python run_workflow.py \
              --mode csv \
              --in-csv "${IN_CSV}" \
              --radius-deg "${RADIUS_DEG}" \
              --limit "${LIMIT}" \
              --knn-k "${KNN_K}" \
              --engine isolation_forest \
              --contamination "${CONTAMINATION}" \
              --top-k "${TOP_K}" \
              --explain-top "${EXPLAIN_TOP}" \
              --seed "${SEED}" \
              --out "${OUT_DIR}" \
              ${PLOT_ARG}
          fi

          echo "Run outputs:"
          ls -la "${OUT_DIR}" || true

      - name: Viz A to H (HTML 3D)
        if: ${{ inputs.generate_viz == 'true' }}
        env:
          RUN_NAME: ${{ inputs.run_name }}
        run: |
          set -euo pipefail

          RUN_DIR="results/${RUN_NAME}"
          SCORED="${RUN_DIR}/scored.csv"
          GRAPH="${RUN_DIR}/graph_full.graphml"
          EXPLAIN="${RUN_DIR}/explanations.jsonl"

          test -f "${SCORED}" || (echo "scored.csv absent: ${SCORED}" && exit 1)

          ARGS=( --run-dir "${RUN_DIR}" --scored "${SCORED}" )

          if [ -f "${GRAPH}" ]; then
            ARGS+=( --graph "${GRAPH}" )
          fi

          if [ -f "${EXPLAIN}" ]; then
            ARGS+=( --explain "${EXPLAIN}" )
          fi

          python tools/viz_a_to_h_suite.py "${ARGS[@]}"

          echo "Viz outputs:"
          find "${RUN_DIR}" -maxdepth 6 -type f \( -name "*.png" -o -name "*.html" -o -name "*.gif" \) | sort || true

          HTML_COUNT="$(find "${RUN_DIR}" -type f -name "*.html" | wc -l | tr -d ' ')"
          if [ "${HTML_COUNT}" = "0" ]; then
            echo "Aucun HTML genere. La 3D n'a pas ete produite."
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: astrographanomaly_${{ inputs.run_name }}
          path: results/${{ inputs.run_name }}
          if-no-files-found: error
          retention-days: 14
