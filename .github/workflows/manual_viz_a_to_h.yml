name: manual_viz_a_to_h

on:
  workflow_dispatch:
    inputs:
      run_name:
        description: "Nom du run (dossier results/<run_name>)"
        required: true
        default: "manual_run"
      python_version:
        description: "Version Python"
        required: true
        default: "3.12"

      mode:
        description: "csv ou gaia"
        required: true
        default: "csv"
      in_csv:
        description: "CSV d'entr√©e (mode csv)"
        required: true
        default: "data/sample_gaia_like.csv"
      ra:
        description: "RA en degres (mode gaia)"
        required: false
        default: "266.4051"
      dec:
        description: "Dec en degres (mode gaia)"
        required: false
        default: "-28.936175"

      radius_deg:
        description: "Rayon en degres"
        required: true
        default: "0.5"
      limit:
        description: "Limite lignes"
        required: true
        default: "2000"

      engine:
        description: "Moteur (isolation_forest, lof, ocsvm, robust_zscore, pineforest)"
        required: true
        default: "isolation_forest"
      threshold_strategy:
        description: "Strategie seuil (contamination, percentile, top_k, score)"
        required: true
        default: "contamination"
      contamination:
        description: "Contamination (si strategie contamination)"
        required: true
        default: "0.05"
      percentile:
        description: "Percentile (si strategie percentile)"
        required: true
        default: "95"
      score_threshold:
        description: "Score threshold (si strategie score)"
        required: true
        default: "0.0"

      knn_k:
        description: "k du graphe kNN"
        required: true
        default: "8"
      features_mode:
        description: "Features (basic ou extended)"
        required: true
        default: "extended"
      top_k:
        description: "Top K anomalies"
        required: true
        default: "30"
      explain_top:
        description: "Nombre d'anomalies expliquees"
        required: true
        default: "5"
      seed:
        description: "Seed"
        required: true
        default: "42"

      plots:
        description: "Produire les PNG (true/false)"
        required: true
        default: "true"
      generate_viz:
        description: "Generer Viz A a H (HTML 3D) (true/false)"
        required: true
        default: "true"

permissions:
  contents: read

jobs:
  run_and_viz:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: pip

      - name: Install deps
        run: |
          set -euo pipefail
          python -V
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          fi
          if [ -f requirements_viz.txt ]; then
            python -m pip install -r requirements_viz.txt
          fi
          if [ -f pyproject.toml ]; then
            python -m pip install -e .
          fi

      - name: Sanity check required files
        run: |
          set -euo pipefail
          test -f run_workflow.py || (echo "run_workflow.py introuvable a la racine" && exit 1)
          if [ "${{ inputs.generate_viz }}" = "true" ]; then
            test -f tools/viz_a_to_h_suite.py || (echo "tools/viz_a_to_h_suite.py absent" && exit 1)
          fi
          python run_workflow.py --help | sed -n '1,120p' || true

      - name: Run core (run_workflow.py)
        env:
          RUN_NAME: ${{ inputs.run_name }}
          MODE: ${{ inputs.mode }}
          IN_CSV: ${{ inputs.in_csv }}
          RA: ${{ inputs.ra }}
          DEC: ${{ inputs.dec }}
          RADIUS_DEG: ${{ inputs.radius_deg }}
          LIMIT: ${{ inputs.limit }}
          ENGINE: ${{ inputs.engine }}
          THRESHOLD_STRATEGY: ${{ inputs.threshold_strategy }}
          CONTAMINATION: ${{ inputs.contamination }}
          PERCENTILE: ${{ inputs.percentile }}
          SCORE_THRESHOLD: ${{ inputs.score_threshold }}
          KNN_K: ${{ inputs.knn_k }}
          FEATURES_MODE: ${{ inputs.features_mode }}
          TOP_K: ${{ inputs.top_k }}
          EXPLAIN_TOP: ${{ inputs.explain_top }}
          SEED: ${{ inputs.seed }}
          PLOTS: ${{ inputs.plots }}
        run: |
          set -euo pipefail

          OUT_DIR="results/${RUN_NAME}"
          mkdir -p "${OUT_DIR}"

          ARGS=( --mode "${MODE}" --radius-deg "${RADIUS_DEG}" --limit "${LIMIT}" --out "${OUT_DIR}" )
          ARGS+=( --engine "${ENGINE}" --threshold-strategy "${THRESHOLD_STRATEGY}" )
          ARGS+=( --knn-k "${KNN_K}" --features-mode "${FEATURES_MODE}" )
          ARGS+=( --top-k "${TOP_K}" --explain-top "${EXPLAIN_TOP}" --seed "${SEED}" )

          if [ "${THRESHOLD_STRATEGY}" = "contamination" ]; then
            ARGS+=( --contamination "${CONTAMINATION}" )
          elif [ "${THRESHOLD_STRATEGY}" = "percentile" ]; then
            ARGS+=( --percentile "${PERCENTILE}" )
          elif [ "${THRESHOLD_STRATEGY}" = "score" ]; then
            ARGS+=( --score-threshold "${SCORE_THRESHOLD}" )
          fi

          if [ "${PLOTS}" = "true" ]; then
            ARGS+=( --plots )
          fi

          if [ "${MODE}" = "gaia" ]; then
            ARGS+=( --ra "${RA}" --dec "${DEC}" )
          else
            ARGS+=( --in-csv "${IN_CSV}" )
          fi

          echo "Command:"
          printf "python run_workflow.py"; printf " %q" "${ARGS[@]}"; echo

          python run_workflow.py "${ARGS[@]}"

          echo "Run outputs:"
          ls -la "${OUT_DIR}" || true

      - name: Viz A to H (HTML 3D)
        if: ${{ inputs.generate_viz == 'true' }}
        env:
          RUN_NAME: ${{ inputs.run_name }}
        run: |
          set -euo pipefail

          RUN_DIR="results/${RUN_NAME}"
          SCORED="${RUN_DIR}/scored.csv"
          GRAPH="${RUN_DIR}/graph_full.graphml"
          EXPLAIN="${RUN_DIR}/explanations.jsonl"

          test -f "${SCORED}" || (echo "scored.csv absent: ${SCORED}" && exit 1)

          VARGS=( --run-dir "${RUN_DIR}" --scored "${SCORED}" )
          if [ -f "${GRAPH}" ]; then
            VARGS+=( --graph "${GRAPH}" )
          fi
          if [ -f "${EXPLAIN}" ]; then
            VARGS+=( --explain "${EXPLAIN}" )
          fi

          echo "Command:"
          printf "python tools/viz_a_to_h_suite.py"; printf " %q" "${VARGS[@]}"; echo

          python tools/viz_a_to_h_suite.py "${VARGS[@]}"

          echo "Viz outputs:"
          find "${RUN_DIR}" -maxdepth 6 -type f \( -name "*.png" -o -name "*.html" -o -name "*.gif" \) | sort || true

          HTML_COUNT="$(find "${RUN_DIR}" -type f -name "*.html" | wc -l | tr -d ' ')"
          if [ "${HTML_COUNT}" = "0" ]; then
            echo "Aucun HTML genere, la 3D n'a pas ete produite"
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: astrographanomaly_${{ inputs.run_name }}
          path: results/${{ inputs.run_name }}
          if-no-files-found: error
          retention-days: 14
