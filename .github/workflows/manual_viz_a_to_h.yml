name: "Manual run + Viz A to H"

on:
  workflow_dispatch:
    inputs:
      run_name:
        description: "Nom du run (dossier results/<run_name>)"
        required: true
        default: "manual_run"
      python_version:
        description: "Version Python"
        required: true
        default: "3.12"
      in_csv:
        description: "Chemin CSV d'entrée"
        required: true
        default: "data/sample_gaia_like.csv"
      limit:
        description: "Limite lignes (0 = pas de limite)"
        required: true
        default: "2000"
      radius_deg:
        description: "Rayon en degrés (si applicable)"
        required: true
        default: "0.5"
      knn_k:
        description: "k du graphe kNN"
        required: true
        default: "8"
      contamination:
        description: "Contamination IsolationForest"
        required: true
        default: "0.05"
      top_k:
        description: "Top K anomalies exportées"
        required: true
        default: "30"
      explain_top:
        description: "Nombre d'anomalies expliquées (LIME)"
        required: true
        default: "5"
      seed:
        description: "Seed"
        required: true
        default: "42"
      generate_viz:
        description: "Générer la suite Viz A à H"
        required: true
        default: "true"

permissions:
  contents: read

concurrency:
  group: astrographanomaly-manual-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run_and_viz:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: "pip"

      - name: Install package (dev)
        run: |
          python -V
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"

      - name: Install viz requirements (optional)
        run: |
          if [ -f requirements_viz.txt ]; then
            python -m pip install -r requirements_viz.txt
          else
            echo "requirements_viz.txt absent, installation viz ignorée"
          fi

      - name: Run core pipeline
        env:
          RUN_NAME: ${{ inputs.run_name }}
          IN_CSV: ${{ inputs.in_csv }}
          LIMIT: ${{ inputs.limit }}
          RADIUS_DEG: ${{ inputs.radius_deg }}
          KNN_K: ${{ inputs.knn_k }}
          CONTAMINATION: ${{ inputs.contamination }}
          TOP_K: ${{ inputs.top_k }}
          EXPLAIN_TOP: ${{ inputs.explain_top }}
          SEED: ${{ inputs.seed }}
        run: |
          set -euo pipefail

          echo "Run core avec IN_CSV=${IN_CSV}, LIMIT=${LIMIT}, RADIUS_DEG=${RADIUS_DEG}, KNN_K=${KNN_K}"
          echo "Engine=isolation_forest, contamination=${CONTAMINATION}, top_k=${TOP_K}, explain_top=${EXPLAIN_TOP}, seed=${SEED}"

          # IMPORTANT
          # Adapte cette commande si ton entrypoint est différent.
          # L'idée est de produire à la fin les fichiers:
          # raw.csv, scored.csv, top_anomalies.csv, graph_full.graphml, graph_topk.graphml,
          # et si possible explanations.jsonl, scored_enriched.csv, plots/, manifest.json

          python -m astrographanomaly.workflow \
            --mode csv \
            --in-csv "${IN_CSV}" \
            --limit "${LIMIT}" \
            --radius-deg "${RADIUS_DEG}" \
            --knn-k "${KNN_K}" \
            --engine isolation_forest \
            --contamination "${CONTAMINATION}" \
            --top-k "${TOP_K}" \
            --explain-top "${EXPLAIN_TOP}" \
            --seed "${SEED}" \
            --plots

      - name: Collect outputs into results/<run_name>
        env:
          RUN_NAME: ${{ inputs.run_name }}
        run: |
          set -euo pipefail
          RUN_DIR="results/${RUN_NAME}"
          mkdir -p "${RUN_DIR}"

          # On copie tout ce qui existe, sans échouer si certains fichiers sont absents
          for f in raw.csv scored.csv scored_enriched.csv top_anomalies.csv graph_full.graphml graph_topk.graphml manifest.json explanations.jsonl llm_prompts.jsonl; do
            if [ -f "${f}" ]; then
              cp -v "${f}" "${RUN_DIR}/"
            fi
          done

          if [ -d plots ]; then
            mkdir -p "${RUN_DIR}/plots"
            cp -vr plots/* "${RUN_DIR}/plots/" || true
          fi

          echo "Contenu de ${RUN_DIR}:"
          ls -la "${RUN_DIR}" || true

      - name: Generate Viz A to H (3D HTML included)
        if: ${{ inputs.generate_viz == 'true' }}
        env:
          RUN_NAME: ${{ inputs.run_name }}
        run: |
          set -euo pipefail
          RUN_DIR="results/${RUN_NAME}"

          if [ ! -f tools/viz_a_to_h_suite.py ]; then
            echo "tools/viz_a_to_h_suite.py absent, impossible de générer A à H"
            exit 1
          fi

          SCORED="${RUN_DIR}/scored.csv"
          GRAPH="${RUN_DIR}/graph_full.graphml"
          EXPLAIN="${RUN_DIR}/explanations.jsonl"

          if [ ! -f "${SCORED}" ]; then
            echo "Fichier manquant: ${SCORED}"
            exit 1
          fi

          ARGS=( --run-dir "${RUN_DIR}" --scored "${SCORED}" )

          if [ -f "${GRAPH}" ]; then
            ARGS+=( --graph "${GRAPH}" )
          else
            echo "graph_full.graphml absent, certaines viz réseau vont dégrader"
          fi

          if [ -f "${EXPLAIN}" ]; then
            ARGS+=( --explain "${EXPLAIN}" )
          else
            echo "explanations.jsonl absent, heatmaps explicabilité en fallback"
          fi

          python tools/viz_a_to_h_suite.py "${ARGS[@]}"

          echo "Sorties viz (si présentes):"
          find "${RUN_DIR}" -maxdepth 3 -type f \( -name "*.png" -o -name "*.html" -o -name "*.gif" \) | sort || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: astrographanomaly_${{ inputs.run_name }}
          path: results/${{ inputs.run_name }}
          if-no-files-found: error
          retention-days: 14
